#+OPTIONS: toc:nil num:nil author:nil creator:nil \n:nil |:t
#+OPTIONS: @:t ::t ^:t -:t f:t *:t <:t

* 将棋のプログラム

  : frame = LiveFrame.players_join
  : frame.piece_plot
  : [
  :   "７六歩", "８四歩", "７八金", "３二金",
  :   "２六歩", "８五歩", "７七角", "３四歩",
  :   "８八銀", "７七角成",
  : ].each{|input|
  :   frame.execute(input)
  : }
  : puts frame.board
  : pp frame.a_move_logs
  : # >>   ９ ８ ７ ６ ５ ４ ３ ２ １
  : # >> +---------------------------+
  : # >> |v香v桂v銀v金v玉 ・v銀v桂v香|一
  : # >> | ・v飛 ・ ・ ・ ・v金 ・ ・|二
  : # >> |v歩 ・v歩v歩v歩v歩 ・v歩v歩|三
  : # >> | ・ ・ ・ ・ ・ ・v歩 ・ ・|四
  : # >> | ・v歩 ・ ・ ・ ・ ・ ・ ・|五
  : # >> | ・ ・ 歩 ・ ・ ・ ・ 歩 ・|六
  : # >> | 歩 歩v馬 歩 歩 歩 歩 ・ 歩|七
  : # >> | ・ 銀 金 ・ ・ ・ ・ 飛 ・|八
  : # >> | 香 桂 ・ ・ 玉 金 銀 桂 香|九
  : # >> +---------------------------+
  : # >> ["▲7六歩(77)",
  : # >>  "▽8四歩(83)",
  : # >>  "▲7八金(69)",
  : # >>  "▽3二金(41)",
  : # >>  "▲2六歩(27)",
  : # >>  "▽8五歩(84)",
  : # >>  "▲7七角(88)",
  : # >>  "▽3四歩(33)",
  : # >>  "▲8八銀(79)",
  : # >>  "▽7七角成(22)"]

** サンプル

*** 駒が動ける場所

    : board = Board.new
    : player = Player.create2(:black, board)
    : player.initial_put_on("５五馬")
    : player.soldiers.first.moveable_points.each{|point|
    :   board.put_on_at(point, "○")
    : }
    : puts board

#+ATTR_HTML: border="1" rules="all" frame="all"
    | 9  | 8  | 7  | 6  | 5  | 4  | 3  | 2  | 1  |    |
    |----+----+----+----+----+----+----+----+----+----|
    | ○ |    |    |    |    |    |    |    | ○ | 一 |
    |    | ○ |    |    |    |    |    | ○ |    | 二 |
    |    |    | ○ |    |    |    | ○ |    |    | 三 |
    |    |    |    | ○ | ○ | ○ |    |    |    | 四 |
    |    |    |    | ○ | 馬 | ○ |    |    |    | 五 |
    |    |    |    | ○ | ○ | ○ |    |    |    | 六 |
    |    |    | ○ |    |    |    | ○ |    |    | 七 |
    |    | ○ |    |    |    |    |    | ○ |    | 八 |
    | ○ |    |    |    |    |    |    |    | ○ | 九 |

*** 座標のパース

    Pointクラス経由で扱えばだいたいパース可

    : Point["4三"].name   # => "4三"
    : Point["４三"].name  # => "4三"
    : Point["43"].name    # => "4三"

    内部では別の座標

    : Point["4三"].to_xy  # => [5, 2]
    : Point[[5, 2]].to_xy # => [5, 2]

*** 駒の情報取得例

    : piece = Piece.get("角")
    : piece.name              # => "角"
    : piece.promoted_name     # => "馬"
    : piece.basic_names       # => ["角", "bishop"]
    : piece.promoted_names    # => ["馬", "BISHOP"]
    : piece.names             # => ["角", "bishop", "馬", "BISHOP"]
    : piece.sym_name          # => :bishop
    : piece.promotable?       # => true
    : piece.basic_vectors1    # => []
    : piece.basic_vectors2    # => [[-1, -1], nil, [1, -1], nil, nil, nil, [-1, 1], nil, [1, 1]]
    : piece.promoted_vectors1 # => [[-1, -1], [0, -1], [1, -1], [-1, 0], nil, [1, 0], [-1, 1], [0, 1], [1, 1]]
    : piece.promoted_vectors2 # => [[-1, -1], nil, [1, -1], nil, nil, nil, [-1, 1], nil, [1, 1]]

*** 盤面上の駒の確認

    : board = Board.new
    : player = Player.create2(:black, board)
    : player.piece_plot
    : puts board

#+ATTR_HTML: border="1" rules="all" frame="all"
    | 9  | 8  | 7  | 6  | 5  | 4  | 3  | 2  | 1  |    |
    |----+----+----+----+----+----+----+----+----+----|
    |    |    |    |    |    |    |    |    |    | 一 |
    |    |    |    |    |    |    |    |    |    | 二 |
    |    |    |    |    |    |    |    |    |    | 三 |
    |    |    |    |    |    |    |    |    |    | 四 |
    |    |    |    |    |    |    |    |    |    | 五 |
    |    |    |    |    |    |    |    |    |    | 六 |
    | 歩 | 歩 | 歩 | 歩 | 歩 | 歩 | 歩 | 歩 | 歩 | 七 |
    |    | 角 |    |    |    |    |    | 飛 |    | 八 |
    | 香 | 桂 | 銀 | 金 | 玉 | 金 | 銀 | 桂 | 香 | 九 |

    : board["５五"]      # => nil
    : board["８八"].name # => "▲8八角"
    : board["２八"].name # => "▲2八飛"
    : board["５九"].name # => "▲5九玉"

*** KIF形式の盤面

    : board = Board.new
    : players = []
    : players << Player.create2(:black, board)
    : players << Player.create2(:white, board)
    : players.each(&:piece_plot)
    : puts board.to_s(:kakiki)
    : # >>   ９ ８ ７ ６ ５ ４ ３ ２ １
    : # >> +---------------------------+
    : # >> |v香v桂v銀v金v玉v金v銀v桂v香|一
    : # >> | ・v飛 ・ ・ ・ ・ ・v角 ・|二
    : # >> |v歩v歩v歩v歩v歩v歩v歩v歩v歩|三
    : # >> | ・ ・ ・ ・ ・ ・ ・ ・ ・|四
    : # >> | ・ ・ ・ ・ ・ ・ ・ ・ ・|五
    : # >> | ・ ・ ・ ・ ・ ・ ・ ・ ・|六
    : # >> | 歩 歩 歩 歩 歩 歩 歩 歩 歩|七
    : # >> | ・ 角 ・ ・ ・ ・ ・ 飛 ・|八
    : # >> | 香 桂 銀 金 玉 金 銀 桂 香|九
    : # >> +---------------------------+

** 仕様

*** 棋譜コマンドの解釈

    | コマンド | 意味               | 詳細                                                                 |
    |----------+--------------------+----------------------------------------------------------------------|
    | 右       | 右の方のを選択     | 移動元を指定座標より右で絞る(龍馬は例外で指定座標を無視し左右の方向) |
    | 左       | 左の方のを選択     | 移動元を指定座標より左で絞る(龍馬は例外で指定座標を無視し左右の方向) |
    | 上       | 下の方のを選択     | 移動元を指定座標より下で絞る                                         |
    | 引       | 上の方のを選択     | 移動元を指定座標より上で絞る                                         |
    | 寄       | 横一列の中から選択 | 移動元を指定座標のY座標で絞る                                        |
    | 直       | 縦一列の中から選択 | 移動元を指定座標のX座標で絞る                                        |

*** 棋譜の表記

    #+ATTR_HTML: border="1" rules="all" frame="all"
    | 表記       | 意味                     |
    |------------+--------------------------|
    | ７六歩(77) | ７七の歩を７六に移動     |
    | ７六歩     | ７六歩(77) の省略形      |
    | ２二角成   | ２二に角が移動して成った |
    | ５五飛打   | ５五に持駒の飛車を打った |
    | 同歩       | 1手前の座標に歩を移動    |

*** 主な例外

    #+ATTR_HTML: border="1" rules="all" frame="all"
    | 例外                            | 意味                                       | どんなときに起きる？               |
    |---------------------------------+--------------------------------------------+------------------------------------|
    | MovableSoldierNotFound          | 指定座標に移動できる駒が一つもない         | ７七に歩がないのに７六歩           |
    | AmbiguousFormatError            | 指定座標に移動できる駒が多くて特定できない | 初手 "５八金"                      |
    | SyntaxError                     | とりあえず表記が違う                       | 駒の配置時に４二銀成とした         |
    | PointSyntaxError                | 座標の表記が違う                           | ４二のつもりで４と書いた           |
    | UnknownPositionName             | 座標の桁の指定が違う                       | ４二のつもりで四２と書いた         |
    | PieceNotFound                   | そんな名前の駒は存在しない                 | 龍のつもりで蛇と書いた             |
    | PieceAlredyExist                | 自分の駒の上に自分の駒を初期配置           | 配置時に2連続で "９七歩"           |
    | SamePlayerSoldierOverwrideError | 自分の駒の上に自分の駒を指した             | 初手 "８八飛(28)"                  |
    | NotPromotable                   | 成れない条件で成ろうとした                 | 初手 "７六歩成"                    |
    | PromotedPiecePutOnError         | 成った状態で打とうとした                   | ５五龍打                           |
    | AlredyPromoted                  | すでに成っている                           | ５五の龍を５一飛成                 |
    | NotFoundOnBoard                 | 盤面に指定の駒がない                       | ２七に歩がないのに２六歩(27)とした |
    | PromotedPieceToNormalPiece      | 成駒を成ってない状態に戻そうとした         | ５五龍を５六飛                     |
    | NotPutInPlaceNotBeMoved         | 移動の見込みがない状態で駒を指せない       | ▲１一桂                           |
    | DoublePawn                      | 二歩                                       | 歩がある縦列に歩を打った           |
    | BeforePointNotFound             | 同に対する座標が不明                       | 初手 "同歩"                        |
    | SoldierEmpty                    | オプションで絞ったら移動できる駒がなくなった   |                                    |

*** 表示座標系

    #+ATTR_HTML: border="1" rules="all" frame="all"
    | 9   | 8 |   7 | 6 | 5 | 4 |   3 | 2 | 1   |    |
    |-----+---+-----+---+---+---+-----+---+-----+----|
    | 9一 |   |     |   |   |   |     |   | 1一 | 一 |
    |     |   |     |   |   |   |     |   |     | 二 |
    |     |   |     |   |   |   | 3三 |   | 1三 | 三 |
    |     |   |     |   |   |   |     |   |     | 四 |
    |     |   |     |   |   |   |     |   |     | 五 |
    |     |   |     |   |   |   |     |   |     | 六 |
    |     |   | 7七 |   |   |   |     |   |     | 七 |
    |     |   |     |   |   |   |     |   |     | 八 |
    | 9九 |   |     |   |   |   |     |   | 1九 | 九 |

*** コード座標系

    #+ATTR_HTML: border="1" rules="all" frame="all"
    |   | 0   | 1 |   2 | 3 | 4 | 5 |   6 | 7 | 8   |
    |---+-----+---+-----+---+---+---+-----+---+-----|
    | 0 | 0,0 |   |     |   |   |   |     |   | 8,0 |
    | 1 |     |   |     |   |   |   |     |   |     |
    | 2 |     |   |     |   |   |   | 6,2 |   | 8,2 |
    | 3 |     |   |     |   |   |   |     |   |     |
    | 4 |     |   |     |   |   |   |     |   |     |
    | 5 |     |   |     |   |   |   |     |   |     |
    | 6 |     |   | 2,6 |   |   |   |     |   |     |
    | 7 |     |   |     |   |   |   |     |   |     |
    | 8 | 0,8 |   |     |   |   |   |     |   | 8,8 |

*** 棋譜のパース

    - "7六歩" の場合 "7六" と "歩" に分離する。
    - "2二角成" の場合 "2二" と "角" と "成" に分離する。
    - 同銀の場合、同がどこを差しているのか、前の座標を見る。
    - "5八金右" の場合、5八から見て右下にある金が斜め上に上がったという意味なのでこの解釈が難しい。
    - "4八" に金があった場合、"5八金右" は真横の金なのか、斜め下の金なのか、どっちだろう。
    - ネット上にある棋譜はだいたい "7六歩(77)" の形式になっていて７七にあったことを明示しているのでがんばって推測しなくてもいい。

*** KIFフォーマット

    : # ----  Kifu for Windows V6.22 棋譜ファイル  ----
    : 開始日時：2000/01/01 00:00:00
    : 終了日時：2000/01/01 01:00:00
    : 棋戦：(棋戦)
    : 持ち時間：(持ち時間)
    : 手合割：平手　　
    : 先手：(先手)
    : 後手：(後手)
    : 手数----指手---------消費時間--
    : *対局前コメント
    :    1 ７六歩(77)   ( 0:10/00:00:10)
    : *コメント1
    :    2 ３四歩(33)   ( 0:10/00:00:20)
    :    3 ６六歩(67)   ( 0:10/00:00:30)
    :    4 ８四歩(83)   ( 0:10/00:00:40)
    : *コメント2
    :    5 投了         ( 0:10/00:00:50)
    : まで4手で後手の勝ち

    - ヘッダーとコンテンツを分けるセパレーターは */^手数.*/*
    - コメントは *直前の指し手* に結び付いている
    - 最初のコメントは *結び付く指し手がない*
    - 「投了」は取り込んだ方がいいのかよくわからない
    - アスタリスクで始まるコメント部分には何を書いてもいいというのを利用して一手目の上に開始前メッセージがあるのがおかしい。結び付く手がない。開始前メッセージはヘッダーに入っていればよかった。
    - 手合割の値の最後に謎の全角スペース2つ。なんじゃこれ

*** KI2フォーマット

    : 開始日時：2000/01/01 00:00
    : 終了日時：2000/01/01 01:00
    : 表題：(表題)
    : 棋戦：(棋戦)
    : 戦型：(戦型)
    : 持ち時間：(持ち時間)
    : 場所：(場所)
    : 掲載：(掲載)
    : 立会人：(立会人)
    : 副立会人：(副立会人)
    : 記録係：(記録係)
    : Web Page：(Web Page)
    : 通算成績：(通算成績)
    : 先手：(先手)
    : 後手：(後手)
    :
    : *対局前コメント
    : ▲７六歩    △３四歩
    : *コメント1
    : ▲６六歩△８四歩
    : *コメント2
    : まで4手で後手の勝ち

    - ヘッダーとコンテンツを分けるセパレーターは *最初の空行*
    - 指し手は横に何個並んでもいいっぽい
    - 指し手のセパレータは *空白ではない* 。くっついている場合もあるので、▲または△、の前で区切る。
    - *投了* がない
    - "#" もない(？)

*** 英語表記対応表

    | 日本語   | 英語     |
    |----------+----------|
    | 歩       | pawn     |
    | 角       | bishop   |
    | 飛       | rook     |
    | 香       | lance    |
    | 桂       | knight   |
    | 銀       | silver   |
    | 金       | gold     |
    | 玉       | king     |
    | 成った   | promoted |
    | 盤面     | board    |
    | 座標     | point    |
    | 相対座標 | vector   |
    | 先手     | black    |
    | 後手     | white    |
    | 対局室   | frame    |

** TODO

   - "不成" の明示指定
   - 例外クラスは引数を受け取って自分でメッセージを作成する
   - 棋譜のXML
   - ki2 kif 相互変換
   - 思考ルーチン
   - WEBで棋譜
   - 陣形名表示
   - 戦術表示
   - USI
   - Windowsブリッジ
   - GUI表示
   - 5x5将棋配置
   - cli

*** 参考リンク集

    - 棋譜の形式について http://wiki.optus.nu/shogi/index.php?post=%B4%FD%C9%E8%A4%CE%B7%C1%BC%B0%A4%CB%A4%C4%A4%A4%A4%C6
    - 寺川唯子先生の将棋レッスン －棋譜の読み方－ ‐ ニコニコ動画:Q http://www.nicovideo.jp/watch/sm1452194
    - 将棋を英語表記するときにblackは何故先手なのか？ - やねうらお－よっちゃんイカを食べながら、息子語録を書き綴る http://d.hatena.ne.jp/yaneurao/20101128
    - 二歩 - Wikipedia http://ja.wikipedia.org/wiki/%E4%BA%8C%E6%AD%A9#cite_note-4
    - せっき～のゲーム屋さん 個性を持った将棋プログラムを目指してー強くするという目標を達成した後にー http://sekigames.gg-blog.com/Entry/242/
    - CC Resources for Shogi Applications | 将棋アプリ用クリエイティブコモンズ画像 http://mucho.girly.jp/bona/
    - 将棋所：USIプロトコルとは http://www.geocities.jp/shogidokoro/usi.html

    - Rubyist Magazine - cairo: 2 次元画像描画ライブラリ http://jp.rubyist.net/magazine/?0019-cairo
    - Emacs LispとRubyを使ってGoogle Chromeを操作する - saito’s blog http://d.hatena.ne.jp/saitodevel01/20110925/1316962117
