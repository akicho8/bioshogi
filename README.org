#+OPTIONS: toc:nil num:nil author:nil creator:nil \n:nil |:t
#+OPTIONS: @:t ::t ^:t -:t f:t *:t <:t

* 将棋のプログラム

  : field = Field.new
  : players = []
  : players << Player.new("先手", field, :lower)
  : players << Player.new("後手", field, :upper)
  : players.each(&:setup)
  : players[0].execute("7六歩")
  : players[1].execute("3四歩")
  : players[0].execute("2二角成")
  : p players[0].pieces.collect(&:name) # => ["角"]
  : puts field

#+ATTR_HTML: border="1" rules="all" frame="all"
  | 9    | 8    | 7    | 6    | 5    | 4    | 3    | 2    | 1    |    |
  |------+------+------+------+------+------+------+------+------+----|
  | 香↓ | 桂↓ | 銀↓ | 金↓ | 玉↓ | 金↓ | 銀↓ | 桂↓ | 香↓ | 一 |
  |      | 飛↓ |      |      |      |      |      | 馬   |      | 二 |
  | 歩↓ | 歩↓ | 歩↓ | 歩↓ | 歩↓ | 歩↓ |      | 歩↓ | 歩↓ | 三 |
  |      |      |      |      |      |      | 歩↓ |      |      | 四 |
  |      |      |      |      |      |      |      |      |      | 五 |
  |      |      | 歩   |      |      |      |      |      |      | 六 |
  | 歩   | 歩   |      | 歩   | 歩   | 歩   | 歩   | 歩   | 歩   | 七 |
  |      |      |      |      |      |      |      | 飛   |      | 八 |
  | 香   | 桂   | 銀   | 金   | 玉   | 金   | 銀   | 桂   | 香   | 九 |

** サンプル

**** 駒が動ける場所

     : field = Field.new
     : player = Player.new("先手", field, :lower)
     : player.initial_put_on("５五馬")
     : player.soldiers.first.moveable_points.each{|point|
     :   field.put_on_at(point, "○")
     : }
     : puts field

#+ATTR_HTML: border="1" rules="all" frame="all"
     | 9  | 8  | 7  | 6  | 5  | 4  | 3  | 2  | 1  |    |
     |----+----+----+----+----+----+----+----+----+----|
     | ○ |    |    |    |    |    |    |    | ○ | 一 |
     |    | ○ |    |    |    |    |    | ○ |    | 二 |
     |    |    | ○ |    |    |    | ○ |    |    | 三 |
     |    |    |    | ○ | ○ | ○ |    |    |    | 四 |
     |    |    |    | ○ | 馬 | ○ |    |    |    | 五 |
     |    |    |    | ○ | ○ | ○ |    |    |    | 六 |
     |    |    | ○ |    |    |    | ○ |    |    | 七 |
     |    | ○ |    |    |    |    |    | ○ |    | 八 |
     | ○ |    |    |    |    |    |    |    | ○ | 九 |

**** 座標のパース

     Pointクラス経由で扱えばだいたいパース可

     : Point["4三"].name   # => "4三"
     : Point["４三"].name  # => "4三"
     : Point["43"].name    # => "4三"

     内部では別の座標

     : Point["4三"].to_xy  # => [5, 2]
     : Point[[5, 2]].to_xy # => [5, 2]

**** 駒の情報取得例

     : piece = Piece.get("角")
     : piece.name              # => "角"
     : piece.promoted_name     # => "馬"
     : piece.basic_names       # => ["角", "bishop"]
     : piece.promoted_names    # => ["馬", "BISHOP"]
     : piece.names             # => ["角", "bishop", "馬", "BISHOP"]
     : piece.sym_name          # => :bishop
     : piece.promotable?       # => true
     : piece.basic_vectors1    # => []
     : piece.basic_vectors2    # => [[-1, -1], nil, [1, -1], nil, nil, nil, [-1, 1], nil, [1, 1]]
     : piece.promoted_vectors1 # => [[-1, -1], [0, -1], [1, -1], [-1, 0], nil, [1, 0], [-1, 1], [0, 1], [1, 1]]
     : piece.promoted_vectors2 # => [[-1, -1], nil, [1, -1], nil, nil, nil, [-1, 1], nil, [1, 1]]

**** 盤面上の駒の確認

     : field = Field.new
     : player = Player.new("先手", field, :lower)
     : player.setup
     : puts field

#+ATTR_HTML: border="1" rules="all" frame="all"
     | 9  | 8  | 7  | 6  | 5  | 4  | 3  | 2  | 1  |    |
     |----+----+----+----+----+----+----+----+----+----|
     |    |    |    |    |    |    |    |    |    | 一 |
     |    |    |    |    |    |    |    |    |    | 二 |
     |    |    |    |    |    |    |    |    |    | 三 |
     |    |    |    |    |    |    |    |    |    | 四 |
     |    |    |    |    |    |    |    |    |    | 五 |
     |    |    |    |    |    |    |    |    |    | 六 |
     | 歩 | 歩 | 歩 | 歩 | 歩 | 歩 | 歩 | 歩 | 歩 | 七 |
     |    | 角 |    |    |    |    |    | 飛 |    | 八 |
     | 香 | 桂 | 銀 | 金 | 玉 | 金 | 銀 | 桂 | 香 | 九 |

     : field["５五"]      # => nil
     : field["８八"].name # => "▲8八角"
     : field["２八"].name # => "▲2八飛"
     : field["５九"].name # => "▲5九玉"

** 仕様

*** 棋譜の表記

    #+ATTR_HTML: border="1" rules="all" frame="all"
    | 9   | 8 |   7 | 6 | 5 | 4 |   3 | 2 | 1   |    |
    |-----+---+-----+---+---+---+-----+---+-----+----|
    | 9一 |   |     |   |   |   |     |   | 1一 | 一 |
    |     |   |     |   |   |   |     |   |     | 二 |

*** 主な例外

    #+ATTR_HTML: border="1" rules="all" frame="all"
    | 例外                            | 意味                                       | どんなときに起きる？                         |
    |---------------------------------+--------------------------------------------+----------------------------------------------|
    | MovableSoldierNotFound          | 指定座標に移動できる駒が一つもない         | ７七に歩がないのに７六歩                     |
    | AmbiguousFormatError            | 指定座標に移動できる駒が多くて特定できない | 初手 "５八金"                                |
    | SyntaxError                     | とりあえず表記が違う                       | 駒の配置時に４二銀成とした(４二成銀が正しい) |
    | PointSyntaxError                | 座標の表記が違う                           | ４二のつもりで４と書いた                     |
    | UnknownPositionName             | 座標の桁の指定が違う                       | ４二のつもりで四２と書いた                   |
    | PieceNotFound                   | そんな名前の駒は存在しない                 | 竜のつもりで蛇と書いた                       |
    | PieceAlredyExist                | 自分の駒の上に自分の駒を初期配置           | 配置時に2連続で "９七歩"                     |
    | SamePlayerSoldierOverwrideError | 自分の駒の上に自分の駒を指した             | 初手 "８八飛(28)"                            |
    | NotPromotable                   | 成れない条件で成ろうとした                 | 初手 "７六歩成"                              |
    | PromotedPiecePutOnError         | 成った状態で打とうとした                   | ５五竜打                                     |
    | AlredyPromoted                  | すでに成っている                           | ５五の龍を５一飛成                           |
    | NotFoundOnField                 | 盤面に指定の駒がない                       | ２七に歩がないのに２六歩(27)とした           |
    | PromotedPieceToNormalPiece      | 成駒を成ってない状態に戻そうとした         | ５五龍を５六飛                               |
    | NotPutInPlaceNotBeMoved         | 移動の見込みない状態で駒を指せない         | ▲１一桂                                     |

*** 座標系

**** 表示座標系

     #+ATTR_HTML: border="1" rules="all" frame="all"
     | 9   | 8 |   7 | 6 | 5 | 4 |   3 | 2 | 1   |    |
     |-----+---+-----+---+---+---+-----+---+-----+----|
     | 9一 |   |     |   |   |   |     |   | 1一 | 一 |
     |     |   |     |   |   |   |     |   |     | 二 |
     |     |   |     |   |   |   | 3三 |   | 1三 | 三 |
     |     |   |     |   |   |   |     |   |     | 四 |
     |     |   |     |   |   |   |     |   |     | 五 |
     |     |   |     |   |   |   |     |   |     | 六 |
     |     |   | 7七 |   |   |   |     |   |     | 七 |
     |     |   |     |   |   |   |     |   |     | 八 |
     | 9九 |   |     |   |   |   |     |   | 1九 | 九 |

**** コード座標系

     #+ATTR_HTML: border="1" rules="all" frame="all"
     |   | 0   | 1 |   2 | 3 | 4 | 5 |   6 | 7 | 8   |
     |---+-----+---+-----+---+---+---+-----+---+-----|
     | 0 | 0,0 |   |     |   |   |   |     |   | 8,0 |
     | 1 |     |   |     |   |   |   |     |   |     |
     | 2 |     |   |     |   |   |   | 6,2 |   | 8,2 |
     | 3 |     |   |     |   |   |   |     |   |     |
     | 4 |     |   |     |   |   |   |     |   |     |
     | 5 |     |   |     |   |   |   |     |   |     |
     | 6 |     |   | 2,6 |   |   |   |     |   |     |
     | 7 |     |   |     |   |   |   |     |   |     |
     | 8 | 0,8 |   |     |   |   |   |     |   | 8,8 |

*** 棋譜のパース

    - "7六歩" の場合 "7六" と "歩" に分離する。
    - "2二角成" の場合 "2二" と "角" と "成" に分離する。
    - 同銀の場合、同がどこを差しているのか、前の座標を見る。
    - "5八金右" の場合、5八から見て右下にある金が斜め上に上がったという意味なのでこの解釈が難しい。
    - "4八" に金があった場合、"5八金右" は真横の金なのか、斜め下の金なのか、どっちだろう。
    - ネット上にある棋譜はだいたい "7六歩(77)" の形式になっていて７七にあったことを明示しているのでがんばって推測しなくてもいい。


*** プログラムで使っている将棋の英語表記対応表

    | 日本語   | 英語     |    |
    |----------+----------+----|
    | 歩       | pawn     |    |
    | 角       | bishop   |    |
    | 飛       | rook     |    |
    | 香       | lance    |    |
    | 桂       | knight   |    |
    | 銀       | silver   |    |
    | 金       | gold     |    |
    | 玉       | king     |    |
    | 成った   | promoted |    |
    | 盤面     | field    |    |
    | 座標     | point    |    |
    | 相対座標 | vector   |    |
    | 対面     | upper    | △ |
    | 自分     | lower    | △ |

*** 関連リンク集

    - Rubyist Magazine - cairo: 2 次元画像描画ライブラリ http://jp.rubyist.net/magazine/?0019-cairo
    - 寺川唯子先生の将棋レッスン －棋譜の読み方－ ‐ ニコニコ動画:Q http://www.nicovideo.jp/watch/sm1452194
    - Emacs LispとRubyを使ってGoogle Chromeを操作する - saito’s blog http://d.hatena.ne.jp/saitodevel01/20110925/1316962117
