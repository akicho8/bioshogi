require "./nega_max"

class NegaScout < NegaMax
  def compute_score(*args)
    nega_scout(*args)
  end

  def nega_scout(turn:, depth_max:, depth: 0, alpha: -Float::INFINITY, beta: Float::INFINITY)
    tle_verify

    player = container.player_at(turn)
    children = container.available_places(player)

    # 一番深い局面に達したらはじめて評価する
    if depth_max <= depth
      return [container.evaluate(player), []] # 現局面手番視点
    end

    # 合法手がない場合はパスして相手に手番を渡す
    if children.empty?
      v, pv = nega_scout(turn: turn + 1, depth_max: depth_max, depth: depth + 1, alpha: -beta, beta: -alpha)
      v = -v
      return [v, [:pass, *pv]]
    end

    # 再帰を簡潔に記述するため
    recursive = -> _place, alpha2, beta2 {
      container.place_on(player, _place) do
        v, pv = nega_scout(turn: turn + 1, depth_max: depth_max, depth: depth + 1, alpha: alpha2, beta: beta2)
        v = -v
        [v, pv]
      end
    }

    # 効果的なもの順に並び換える
    children = container.move_ordering(player, children)

    # 最善候補を通常の窓で探索
    place = children.shift
    v, pv = recursive.(place, -beta, -alpha)
    max_v = v
    best_pv = [place, *pv]
    if beta <= v
      return [v, [place, *pv]]
    end
    if alpha < v
      alpha = v
    end

    best_pv = []
    children.each do |place|
      v, pv = recursive.(place, -(alpha + 1), -alpha) # null window search
      if beta <= v
        return [v, [place, *pv]]
      end
      if alpha < v
        alpha = v
        v, pv = recursive.(place, -beta, -alpha) # 通常の窓で再探索
        if beta <= v
          return [v, [place, *pv]]
        end
        if alpha < v
          alpha = v
        end
      end
      if max_v < v
        max_v = v
        best_pv = [place, *pv]
      end
    end

    [max_v, best_pv]
  end
end

if $0 == __FILE__
  NegaScout.new(dimension_size: 4, depth_max: 6).run             # => {:o=>2, :x=>14}
end
# >> ------------------------------------------------------------ [0] o 実行速度:0.306705
# >> ・○・・
# >> ・○○・
# >> ・○×・
# >> ・・・・
# >> |------+--------+----------------------+--------+------+------|
# >> | 順位 | 候補手 | 読み筋               | 評価値 | 形勢 | 時間 |
# >> |------+--------+----------------------+--------+------+------|
# >> |    1 | [1, 0] |                      |     -1 |   -1 |      |
# >> |    2 | [0, 1] |                      |     -1 |   -1 |      |
# >> |    3 | [3, 2] | [3, 3] [2, 3] [3, 1] |     -1 |   -1 |      |
# >> |    4 | [2, 3] | [3, 3] [3, 2] [3, 1] |     -1 |   -1 |      |
# >> |------+--------+----------------------+--------+------+------|
# >> ------------------------------------------------------------ [1] x 実行速度:0.18605
# >> ×○・・
# >> ・×○・
# >> ・○×・
# >> ・・・・
# >> |------+--------+-------------------------------------------+--------+------+------|
# >> | 順位 | 候補手 | 読み筋                                    | 評価値 | 形勢 | 時間 |
# >> |------+--------+-------------------------------------------+--------+------+------|
# >> |    1 | [0, 0] |                                           |      6 |   -6 |      |
# >> |    2 | [0, 2] | [2, 3] [3, 2] [3, 3] [2, 0] [1, 3] [0, 0] |     -2 |    2 |      |
# >> |    3 | [2, 0] |                                           |     -7 |    7 |      |
# >> |------+--------+-------------------------------------------+--------+------+------|
# >> ------------------------------------------------------------ [2] o 実行速度:0.093327
# >> ×○・・
# >> ○○○・
# >> ・○×・
# >> ・・・・
# >> |------+--------+--------+--------+------+------|
# >> | 順位 | 候補手 | 読み筋 | 評価値 | 形勢 | 時間 |
# >> |------+--------+--------+--------+------+------|
# >> |    1 | [0, 1] |        |     -3 |   -3 |      |
# >> |    2 | [3, 2] |        |     -9 |   -9 |      |
# >> |    3 | [2, 3] |        |     -9 |   -9 |      |
# >> |------+--------+--------+--------+------+------|
# >> ------------------------------------------------------------ [3] x 実行速度:0.064307
# >> ×××・
# >> ○○×・
# >> ・○×・
# >> ・・・・
# >> |------+--------+--------+--------+------+------|
# >> | 順位 | 候補手 | 読み筋 | 評価値 | 形勢 | 時間 |
# >> |------+--------+--------+--------+------+------|
# >> |    1 | [2, 0] |        |      8 |   -8 |      |
# >> |    2 | [0, 2] |        |      8 |   -8 |      |
# >> |------+--------+--------+--------+------+------|
# >> ------------------------------------------------------------ [4] o 実行速度:0.106021
# >> ×××・
# >> ○○○○
# >> ・○×・
# >> ・・・・
# >> |------+--------+--------+--------+------+------|
# >> | 順位 | 候補手 | 読み筋 | 評価値 | 形勢 | 時間 |
# >> |------+--------+--------+--------+------+------|
# >> |    1 | [3, 1] |        |     -6 |   -6 |      |
# >> |    2 | [3, 0] |        |     -8 |   -8 |      |
# >> |    3 | [3, 3] |        |     -8 |   -8 |      |
# >> |    4 | [3, 2] |        |     -9 |   -9 |      |
# >> |------+--------+--------+--------+------+------|
# >> ------------------------------------------------------------ [5] x 実行速度:0.052546
# >> ×××・
# >> ××○○
# >> ×××・
# >> ・・・・
# >> |------+--------+----------------------+--------+------+------|
# >> | 順位 | 候補手 | 読み筋               | 評価値 | 形勢 | 時間 |
# >> |------+--------+----------------------+--------+------+------|
# >> |    1 | [0, 2] |                      |      9 |   -9 |      |
# >> |    2 | [1, 3] | [0, 3] [0, 2]        |      9 |   -9 |      |
# >> |    3 | [3, 2] | [3, 0] [1, 3] [3, 3] |      1 |   -1 |      |
# >> |------+--------+----------------------+--------+------+------|
# >> ------------------------------------------------------------ [6] o 実行速度:0.030787
# >> ×××・
# >> ××○○
# >> ×○×・
# >> ○・・・
# >> |------+--------+---------------------------+--------+------+------|
# >> | 順位 | 候補手 | 読み筋                    | 評価値 | 形勢 | 時間 |
# >> |------+--------+---------------------------+--------+------+------|
# >> |    1 | [0, 3] | [1, 3] [2, 3] [3, 0] PASS |     -9 |   -9 |      |
# >> |    2 | [2, 3] | [3, 0] PASS               |    -11 |  -11 |      |
# >> |    3 | [1, 3] | [3, 0] PASS [3, 3] PASS   |    -12 |  -12 |      |
# >> |------+--------+---------------------------+--------+------+------|
# >> ------------------------------------------------------------ [7] x 実行速度:0.013885
# >> ×××・
# >> ××○○
# >> ×××・
# >> ○・×・
# >> |------+--------+--------+--------+------+------|
# >> | 順位 | 候補手 | 読み筋 | 評価値 | 形勢 | 時間 |
# >> |------+--------+--------+--------+------+------|
# >> |    1 | [2, 3] |        |     12 |  -12 |      |
# >> |    2 | [1, 3] |        |     10 |  -10 |      |
# >> |    3 | [3, 2] |        |     -2 |    2 |      |
# >> |------+--------+--------+--------+------+------|
# >> ------------------------------------------------------------ [8] o 実行速度:0.004236
# >> ×××・
# >> ××○○
# >> ××○・
# >> ○○×・
# >> |------+--------+-------------+--------+------+------|
# >> | 順位 | 候補手 | 読み筋      | 評価値 | 形勢 | 時間 |
# >> |------+--------+-------------+--------+------+------|
# >> |    1 | [1, 3] | [3, 3] PASS |    -12 |  -12 |      |
# >> |------+--------+-------------+--------+------+------|
# >> ------------------------------------------------------------ [9] x 実行速度:0.002762
# >> ×××・
# >> ××○○
# >> ×××・
# >> ○○××
# >> |------+--------+--------+--------+------+------|
# >> | 順位 | 候補手 | 読み筋 | 評価値 | 形勢 | 時間 |
# >> |------+--------+--------+--------+------+------|
# >> |    1 | [3, 3] | PASS   |     12 |  -12 |      |
# >> |    2 | [3, 0] |        |      8 |   -8 |      |
# >> |    3 | [3, 2] |        |     -2 |    2 |      |
# >> |------+--------+--------+--------+------+------|
# >> ------------------------------------------------------------ [10] o 実行速度:0.000125
# >> ×××・
# >> ××○○
# >> ×××・
# >> ○○××
# >> (pass)
# >> ------------------------------------------------------------ [11] x 実行速度:0.00103
# >> ××××
# >> ×××○
# >> ×××・
# >> ○○××
# >> |------+--------+--------+--------+------+------|
# >> | 順位 | 候補手 | 読み筋 | 評価値 | 形勢 | 時間 |
# >> |------+--------+--------+--------+------+------|
# >> |    1 | [3, 0] | PASS   |     12 |  -12 |      |
# >> |    2 | [3, 2] |        |      4 |   -4 |      |
# >> |------+--------+--------+--------+------+------|
# >> ------------------------------------------------------------ [12] o 実行速度:8.2e-05
# >> ××××
# >> ×××○
# >> ×××・
# >> ○○××
# >> (pass)
# >> ------------------------------------------------------------ [13] x 実行速度:0.000365
# >> ××××
# >> ××××
# >> ××××
# >> ○○××
# >> |------+--------+-------------------------------+--------+------+------|
# >> | 順位 | 候補手 | 読み筋                        | 評価値 | 形勢 | 時間 |
# >> |------+--------+-------------------------------+--------+------+------|
# >> |    1 | [3, 2] | PASS PASS PASS PASS PASS PASS |     12 |  -12 |      |
# >> |------+--------+-------------------------------+--------+------+------|
# >> |---+----|
# >> | o | 2  |
# >> | x | 14 |
# >> |---+----|
