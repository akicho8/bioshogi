# ミニマックスの綺麗な実装

require "./dirty_minimax"

class Minimax < DirtyMinimax
  def mini_max(turn:, depth_max:, depth: 0)
    tle_verify

    # 一番深い局面に達したらはじめて評価する
    if depth_max <= depth
      return [mediator.evaluate(:o), []] # 常に「先手から」の評価値
    end

    # 合法手がない場合はパスして相手に手番を渡す
    player = mediator.player_at(turn)
    children = mediator.available_places(player)
    if children.empty?
      v, pv = mini_max(turn: turn + 1, depth_max: depth_max, depth: depth + 1)
      return [v, [:pass, *pv]]
    end

    if turn.even?
      max = -Float::INFINITY
    else
      max = Float::INFINITY
    end

    best_pv = []
    children.each do |place|
      mediator.place_on(player, place) do
        v, pv = mini_max(turn: turn + 1, depth_max: depth_max, depth: depth + 1)
        if turn.even?
          flag = v > max # 自分が自分にとってもっとも有利な手を選択する
        else
          flag = v < max # 相手が自分にとってもっとも不利な手を選択する
        end
        if flag
          best_pv = [place, *pv]
          max = v
        end
      end
    end
    [max, best_pv]
  end
end

if $0 == __FILE__
  Minimax.new.run         # => {:o=>1, :x=>10}
end
# >> ------------------------------------------------------------ [0] o 実行速度:0.040098
# >> ・○・・
# >> ・○○・
# >> ・○×・
# >> ・・・・
# >> |------+--------+----------------------+--------|
# >> | 順位 | 候補手 | 読み筋               | 評価値 |
# >> |------+--------+----------------------+--------|
# >> |    1 | [1, 0] | [0, 0] [3, 2] [2, 0] |      0 |
# >> |    2 | [0, 1] | [0, 0] [3, 2] [3, 1] |      0 |
# >> |    3 | [3, 2] | [1, 3] [0, 0] [1, 0] |      0 |
# >> |    4 | [2, 3] | [3, 1] [0, 0] [0, 1] |      0 |
# >> |------+--------+----------------------+--------|
# >> ------------------------------------------------------------ [1] x 実行速度:0.030178
# >> ×○・・
# >> ・×○・
# >> ・○×・
# >> ・・・・
# >> |------+--------+----------------------+--------|
# >> | 順位 | 候補手 | 読み筋               | 評価値 |
# >> |------+--------+----------------------+--------|
# >> |    1 | [0, 0] | [3, 2] [2, 0] [0, 1] |      3 |
# >> |    2 | [0, 2] | [0, 3] [2, 0] [3, 0] |      3 |
# >> |    3 | [2, 0] | [3, 0] [0, 0] [0, 1] |      5 |
# >> |------+--------+----------------------+--------|
# >> ------------------------------------------------------------ [2] o 実行速度:0.01949
# >> ×○・・
# >> ・×○・
# >> ・○○○
# >> ・・・・
# >> |------+--------+----------------------+--------|
# >> | 順位 | 候補手 | 読み筋               | 評価値 |
# >> |------+--------+----------------------+--------|
# >> |    1 | [3, 2] | [2, 0] [0, 1] [0, 2] |     -2 |
# >> |    2 | [2, 3] | [2, 0] [0, 1] [0, 2] |     -2 |
# >> |    3 | [0, 1] | [2, 0] [3, 2] [0, 2] |     -4 |
# >> |------+--------+----------------------+--------|
# >> ------------------------------------------------------------ [3] x 実行速度:0.017439
# >> ×××・
# >> ・×○・
# >> ・○○○
# >> ・・・・
# >> |------+--------+----------------------+--------|
# >> | 順位 | 候補手 | 読み筋               | 評価値 |
# >> |------+--------+----------------------+--------|
# >> |    1 | [2, 0] | [0, 1] [0, 2] PASS   |     -2 |
# >> |    2 | [3, 3] | [0, 1] [2, 0] [3, 0] |      1 |
# >> |    3 | [1, 3] | [0, 1] [2, 0] [0, 2] |      3 |
# >> |    4 | [3, 1] | [3, 0] [2, 0] [0, 1] |      5 |
# >> |------+--------+----------------------+--------|
# >> ------------------------------------------------------------ [4] o 実行速度:0.00649
# >> ×××・
# >> ○○○・
# >> ・○○○
# >> ・・・・
# >> |------+--------+--------------------+--------|
# >> | 順位 | 候補手 | 読み筋             | 評価値 |
# >> |------+--------+--------------------+--------|
# >> |    1 | [0, 1] | [0, 2] PASS [2, 3] |     -9 |
# >> |------+--------+--------------------+--------|
# >> ------------------------------------------------------------ [5] x 実行速度:0.013113
# >> ×××・
# >> ××○・
# >> ×○○○
# >> ・・・・
# >> |------+--------+----------------------+--------|
# >> | 順位 | 候補手 | 読み筋               | 評価値 |
# >> |------+--------+----------------------+--------|
# >> |    1 | [0, 2] | PASS [2, 3] PASS     |     -9 |
# >> |    2 | [3, 3] | [2, 3] [0, 2] PASS   |     -2 |
# >> |    3 | [2, 3] | [3, 3] [0, 2] [3, 0] |     -1 |
# >> |    4 | [1, 3] | [0, 3] [3, 1] [3, 0] |      1 |
# >> |------+--------+----------------------+--------|
# >> ------------------------------------------------------------ [6] o 実行速度:0.00026
# >> ×××・
# >> ××○・
# >> ×○○○
# >> ・・・・
# >> (pass)
# >> ------------------------------------------------------------ [7] x 実行速度:0.006127
# >> ×××・
# >> ×××・
# >> ×××○
# >> ・・×・
# >> |------+--------+----------------------+--------|
# >> | 順位 | 候補手 | 読み筋               | 評価値 |
# >> |------+--------+----------------------+--------|
# >> |    1 | [2, 3] | PASS PASS PASS       |     -9 |
# >> |    2 | [1, 3] | [0, 3] [2, 3] [3, 0] |     -4 |
# >> |    3 | [3, 3] | [2, 3] [3, 1] [3, 0] |     -4 |
# >> |    4 | [3, 1] | [3, 0] [2, 3] [0, 3] |     -2 |
# >> |------+--------+----------------------+--------|
# >> ------------------------------------------------------------ [8] o 実行速度:0.000259
# >> ×××・
# >> ×××・
# >> ×××○
# >> ・・×・
# >> (pass)
# >> ------------------------------------------------------------ [9] x 実行速度:0.000312
# >> ×××・
# >> ×××・
# >> ×××○
# >> ・・×・
# >> (pass)
# >> 連続パスで終了
# >> |---+----|
# >> | o | 1  |
# >> | x | 10 |
# >> |---+----|
